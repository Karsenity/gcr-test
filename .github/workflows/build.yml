name: Push to GCR GitHub Action
on:
  - push
  - workflow_dispatch

jobs:

  FindEnvironment:
    name: Finding Right Environment
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.find_name.outputs.env_name }}
    steps:
      - id: find_name
        run: |
          if [[ ${{ github.event.ref }} == refs/heads/main ]]
          then
            echo "::set-output name=env_name::stage"
          elif [[ ${{ github.event.ref }} == refs/heads/production ]]
          then
            echo "::set-output name=env_name::prod"
          else
            echo "::set-output name=env_name::dev"
          fi    

  Build:
    needs: FindEnvironment
    name: Deploy / ${{ needs.FindEnvironment.outputs.env_name }}
    uses: ./.github/workflows/build-and-save-to-gcr.yml
    with:
      env-name: ${{ needs.FindEnvironment.outputs.env_name }}
    secrets: inherit
  
  Debug:
    name: Debug
    needs: FindEnvironment
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo ${{ needs.FindEnvironment.outputs.env_name }}
    

